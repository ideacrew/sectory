defmodule SectoryWeb.SbomVulnerabilityReportHTML do
  use SectoryWeb, :html

  embed_templates "sbom_vulnerability_report_html/*"

  def component_name(analysis) do
    analysis["metadata"]["component"]["name"]
  end

  def component_version(analysis) do
    comp = analysis["metadata"]["component"]
    case Map.has_key?(comp, "version") do
      false -> extract_git_sha(comp)
      _ -> comp["version"]
    end
  end

  def analysis_timestamp(analysis) do
    Date.utc_today()
  end

  defp extract_git_sha(comp) do
    case Map.has_key?(comp, "hashes") do
      false -> "unknown"
      _ -> Enum.find(comp["hashes"], %{"content" => "Unspecified" }, fn(v) ->
        v["alg"] == "SHA-1"
      end)["content"]
    end
  end
end
