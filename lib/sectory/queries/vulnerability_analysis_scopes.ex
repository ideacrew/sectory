defmodule Sectory.Queries.VulnerabilityAnalysisScopes do
  import Ecto.Query

  @moduledoc """
  Shared queries for Vulnerability Analysis Scopes.
  """

  def all() do
    query = (
      from vas in Sectory.Records.VulnerabilityAnalysisScope,
      join: va in assoc(vas, :vulnerability_analysis),
      left_join: d in assoc(vas, :deliverable),
      left_join: dv in assoc(vas, :deliverable_version),
      left_join: d2 in assoc(dv, :deliverable),
      order_by: [vas.vulnerability_identifier, vas.deliverable_id, vas.deliverable_id],
      preload: [
        deliverable: d,
        deliverable_version: {dv, [deliverable: d2]},
        vulnerability_analysis: va
      ]
    )
    Sectory.Repo.all(query)
  end
end
